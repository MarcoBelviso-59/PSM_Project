name: API Smoketest (experiments endpoints)

on:
  workflow_dispatch:
  push:
    paths:
      - "**/src/api/**"
      - "**/src/experiments/**"
      - "**/src/engine/**"
      - ".github/workflows/api_smoketest.yml"

jobs:
  smoketest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Locate API & Experiments folders (absolute paths)
        id: locate
        shell: bash
        run: |
          set -e
          API_PKG="$(find . -type f -path "*/src/api/package.json" -print -quit || true)"
          EXP_PKG="$(find . -type f -path "*/src/experiments/package.json" -print -quit || true)"

          echo "API_PKG=$API_PKG"
          echo "EXP_PKG=$EXP_PKG"

          if [ -z "$API_PKG" ]; then
            echo "ERROR: Could not find */src/api/package.json"
            find . -maxdepth 4 -type d
            exit 1
          fi
          if [ -z "$EXP_PKG" ]; then
            echo "ERROR: Could not find */src/experiments/package.json"
            find . -maxdepth 4 -type d
            exit 1
          fi

          API_DIR_REL="$(dirname "$API_PKG")"
          EXP_DIR_REL="$(dirname "$EXP_PKG")"

          API_DIR_ABS="$(cd "$API_DIR_REL" && pwd -P)"
          EXP_DIR_ABS="$(cd "$EXP_DIR_REL" && pwd -P)"

          echo "Found API dir (abs): $API_DIR_ABS"
          echo "Found EXP dir (abs): $EXP_DIR_ABS"

          echo "api_dir=$API_DIR_ABS" >> $GITHUB_OUTPUT
          echo "exp_dir=$EXP_DIR_ABS" >> $GITHUB_OUTPUT

      # --- Prepare a smoke run in outputs/ ---
      - name: Install dependencies (experiments)
        working-directory: ${{ steps.locate.outputs.exp_dir }}
        run: npm install

      - name: Generate dataset (v1 - tiny smoke)
        working-directory: ${{ steps.locate.outputs.exp_dir }}
        run: node tools/generate_dataset.js datasets/dataset_v1.json 5 --seed 12345

      - name: Run experiment (smoke)
        working-directory: ${{ steps.locate.outputs.exp_dir }}
        shell: bash
        run: |
          set -e
          rm -rf outputs/run_smoke_ci || true
          node run.js --in datasets/dataset_v1.json --out outputs/run_smoke_ci --redact-password --seed 12345
          echo "== outputs listing =="
          ls -la outputs || true
          echo "== run_smoke_ci listing =="
          ls -la outputs/run_smoke_ci || true

      # --- Start API pointing to experiments outputs (ABSOLUTE) ---
      - name: Install dependencies (api)
        working-directory: ${{ steps.locate.outputs.api_dir }}
        run: npm install

      - name: Start API (background)
        working-directory: ${{ steps.locate.outputs.api_dir }}
        env:
          PORT: "3000"
          PSM_EXPERIMENTS_DIR: ${{ steps.locate.outputs.exp_dir }}/outputs
        shell: bash
        run: |
          set -e
          echo "PSM_EXPERIMENTS_DIR=$PSM_EXPERIMENTS_DIR"
          ls -la "$PSM_EXPERIMENTS_DIR" || true
          nohup node server.js > api.log 2>&1 &
          echo $! > api.pid

      - name: Wait for API to be ready
        shell: bash
        run: |
          set -e
          for i in {1..30}; do
            if curl -sSf http://localhost:3000/health >/dev/null; then
              echo "API is ready"
              exit 0
            fi
            sleep 1
          done
          echo "API did not become ready in time"
          exit 1

      # --- Smoke test endpoints ---
      - name: Test /experiments (list) + capture runId
        id: capture
        shell: bash
        run: |
          set -e
          curl -sSf http://localhost:3000/experiments -o runs.json
          echo "== /experiments response =="
          cat runs.json
          RUN_ID="$(node -e "const x=require('./runs.json'); console.log((x.runs && x.runs[0]) || '')")"
          if [ -z "$RUN_ID" ]; then
            echo "ERROR: No runs returned by /experiments"
            exit 1
          fi
          echo "Using RUN_ID=$RUN_ID"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Test /experiments/:runId (detail)
        run: curl -sSf "http://localhost:3000/experiments/${{ steps.capture.outputs.run_id }}?limit=2"

      - name: Test export TSV
        shell: bash
        run: |
          set -e
          curl -sSf "http://localhost:3000/experiments/${{ steps.capture.outputs.run_id }}/export?format=tsv" -o out.tsv
          test -s out.tsv

      - name: Test export excelcsv
        shell: bash
        run: |
          set -e
          curl -sSf "http://localhost:3000/experiments/${{ steps.capture.outputs.run_id }}/export?format=excelcsv" -o out.csv
          test -s out.csv

      # --- Cleanup & logs ---
      - name: Stop API and print logs
        if: always()
        working-directory: ${{ steps.locate.outputs.api_dir }}
        shell: bash
        run: |
          if [ -f api.pid ]; then kill $(cat api.pid) || true; fi
          echo "== api.log (last 200 lines) =="
          tail -n 200 api.log || true
